<!DOCTYPE html>
<html>
<!--
    Exchange the line above for this to enable offline support
    <html manifest="manifest.appcache">

    Please make your homework before doing this:
        http://www.alistapart.com/articles/application-cache-is-a-douchebag/
        http://appcachefacts.info

    This might be necessary to set up on your server, to make sure
    files are updated when the appcache file itself is:
        https://github.com/robnyman/Firefox-OS-Boilerplate-App/blob/gh-pages/.htaccess
 -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="css/base.css">
    <link rel="stylesheet" type="text/css" href="css/headers.css">
    <link rel="stylesheet" type="text/css" href="css/buttons.css">
    <link rel="stylesheet" type="text/css" href="css/toolbars.css">
    <title>Firefox OS Boilerplate App</title>
</head>

<body>

    <h1>Instacloser</h1>

    <script type="text/javascript" src="js/base.js"></script>
    <script type="text/javascript" src="js/webapp.js"></script>
    <script type="text/javascript" src="js/offline.js"></script>
    <script type="text/javascript" src="vendor/components/zepto/zepto.js"></script>

    <!--
        Loosely based on fxosstub: https://github.com/Jaxo/fxosstub
    -->

    <div>
        <a id="instalogin" href="https://instagram.com/oauth/authorize/?client_id=fb8cffd8c00b42ea8105109388afe0b8&redirect_uri=http://localhost:9001/instagram.html&response_type=token">Instagram login</a>
    <div>

    <script type="text/javascript">

        function Instacloser(){
            this.accessToken = false;
            this.lat = false;
            this.lng = false;

            this.init();
        };
        Instacloser.prototype.init = function() {
            this.getAccessToken();
            this.getLocalization();
        };
        Instacloser.prototype.getAccessToken = function() {
            hash = getHash();
            if(''!=hash){
                hash = hash.split('=');
                if(2===hash.length){
                    this.accessToken = hash[1];
                    console.log('hash: '+this.accessToken);                
                }
            }
            else{
                console.warn('there is no logged in user');
            }
        }
        Instacloser.prototype.getLocalization = function() {
            // this should be changed of course
            this.lat = -30.060472;
            this.lng = -51.175533;
        }
        Instacloser.prototype.asyncPics = function() {
            // if(!this.lat || !this.lng){
                // console.log('You shold try to be in Earth');
                // return;
            // }
            self = this;
            lat = this.lat;
            lng = this.lng;
            accessToken = this.accessToken;

            $.ajax({
                url : 'https://api.instagram.com/v1/media/search?lat='+lat+'&lng='+lng+'&access_token='+accessToken+'',
                dataType : 'jsonp',
                success : $.proxy(self.drawPics, self),
                error : function (error) {
                    console.log(error, 'Oh no, Ben Affleck is Batman');
                }
            });
        };
        Instacloser.prototype.drawPics = function(res) {
            $.each(res.data, function (i, local) {
                console.log(local);

                // curentLat: local.latitude,
                // currentLng: local.longitude,
                // title: local.name,

                // map.addMarker({
                    
                //     title: local.name,
                //     infoWindow: {
                //         content: '<div class="l'+local.id+(new Date()).getTime()+' marker" data-id="'+local.id+'" data-class=".l'+local.id+(new Date()).getTime()+'">'+local.name+'</div>'
                //     },
                //     click: function(marker) {

                //         // Encontra o elemento do maker e o seleciona
                //         var j$ = $(this.infoWindow.content);
                //         var $marker = $(j$.attr('data-class'));

                //         app.whenMarkerReady(j$.attr('data-class'), app.onClickInMarker);
                //     }
                // });
            });
        };


        // util functions
        function getHash() {
          var hash = window.location.hash;
          return hash.substring(1); // remove #
        }
         
        function getLinkTarget(link) {
          return link.href.substring(link.href.indexOf('#')+1);
        }

        window.onload = function(){                        
            app = new Instacloser();
        }
    </script>

</body>
</html>
